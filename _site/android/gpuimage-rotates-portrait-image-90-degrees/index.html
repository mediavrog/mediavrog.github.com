<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>GPUImage dreht Portrait-Bild nach Fotografieren mit Kamera<!--:en-->GPUImage rotates an image shot in portrait mode by 90 degrees &#8211; mediavrog</title>
<meta name="description" content="The other day I came across a small issue, while using the [Android port of GPUImage][1]. On some devices (mainly Samsung), an image captured in portrait by the camera intent and then fed to GPUImageView would be rotated by 90 degrees. On other devices, this would work perfectly. Also, selecting an already captured image from the gallery worked just fine.

">
<meta name="keywords" content="android, app, camera, gpuimage, orientation, photo, rotation">


<!-- Twitter Cards -->
<meta name="twitter:title" content="GPUImage dreht Portrait-Bild nach Fotografieren mit Kamera<!--:en-->GPUImage rotates an image shot in portrait mode by 90 degrees">
<meta name="twitter:description" content="The other day I came across a small issue, while using the [Android port of GPUImage][1]. On some devices (mainly Samsung), an image captured in portrait by the camera intent and then fed to GPUImageView would be rotated by 90 degrees. On other devices, this would work perfectly. Also, selecting an already captured image from the gallery worked just fine.

">
<meta name="twitter:site" content="@mediavrog">
<meta name="twitter:creator" content="@mediavrog">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://127.0.0.1:4000/images/device-2013-08-27-104732preview.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="GPUImage dreht Portrait-Bild nach Fotografieren mit Kamera<!--:en-->GPUImage rotates an image shot in portrait mode by 90 degrees">
<meta property="og:description" content="The other day I came across a small issue, while using the [Android port of GPUImage][1]. On some devices (mainly Samsung), an image captured in portrait by the camera intent and then fed to GPUImageView would be rotated by 90 degrees. On other devices, this would work perfectly. Also, selecting an already captured image from the gallery worked just fine.

">
<meta property="og:url" content="http://127.0.0.1:4000/android/gpuimage-rotates-portrait-image-90-degrees/">
<meta property="og:site_name" content="mediavrog">

<meta property="og:image" content="http://127.0.0.1:4000/images/device-2013-08-27-104732preview.png">






<link rel="canonical" href="http://127.0.0.1:4000/android/gpuimage-rotates-portrait-image-90-degrees/">
<link href="http://127.0.0.1:4000/feed.xml" type="application/atom+xml" rel="alternate" title="mediavrog Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://127.0.0.1:4000/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="http://127.0.0.1:4000/assets/js/vendor/html5shiv.min.js"></script>
	<script src="http://127.0.0.1:4000/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://127.0.0.1:4000/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400,300" />

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://127.0.0.1:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://127.0.0.1:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://127.0.0.1:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://127.0.0.1:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://127.0.0.1:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://127.0.0.1:4000/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="http://127.0.0.1:4000/">mediavrog</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav id="site-nav" class="nav">
		    <ul>
		        
				    
				    <li><a href="http://127.0.0.1:4000/about/" >About</a></li>
				
				    
				    <li><a href="http://127.0.0.1:4000/blog/" >Blog</a></li>
				
				    
				    <li><a href="http://127.0.0.1:4000/projects/" >Projects</a></li>
				
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->




<div id="main" role="main">
  <div class="article-author-side">
    

<div itemscope itemtype="http://schema.org/Person">


	<img src="http://127.0.0.1:4000/images/bio-photo.png" class="bio-photo" alt="Maik Vlcek bio photo">


  <h4 itemprop="name">Maik Vlcek</h4>
  <p><small>Full stack & mobile engineer</small></p>
  
  
  <a href="http://twitter.com/mediavrog" class="author-social" target="_blank"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a>
  
  
  
  
  
  
  <a href="http://github.com/mediavrog" class="author-social" target="_blank"><i class="fa fa-fw fa-github"></i> Github</a>
  
  
  
  
  
  
  
  
  
  
  
</div>

  </div>
  <article class="post">
    <div class="headline-wrap">
      
        <h1><a href="http://127.0.0.1:4000/android/gpuimage-rotates-portrait-image-90-degrees/" rel="bookmark" title="GPUImage dreht Portrait-Bild nach Fotografieren mit Kamera<!--:en-->GPUImage rotates an image shot in portrait mode by 90 degrees">GPUImage dreht Portrait-Bild nach Fotografieren mit Kamera<!--:en-->GPUImage rotates an image shot in portrait mode by 90 degrees</a></h1>
      
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
      <p>The other day I came across a small issue, while using the <a href="https://github.com/CyberAgent/android-gpuimage">Android port of GPUImage</a>. On some devices (mainly Samsung), an image captured in portrait by the camera intent and then fed to GPUImageView would be rotated by 90 degrees. On other devices, this would work perfectly. Also, selecting an already captured image from the gallery worked just fine.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Despite being captured in portrait mode, the resulting image will be rotated when loaded in GPUImageView
</code></pre>
</div>

<p>I first noticed that the problematic devices were all setting the device orientation to landscape when opening up the camera mode. There were a few noticeable rotations during the process of capturing and reviewing an image. I thought they would somehow write wrong Exif data into the image, but I soon was proved wrong.</p>

<p>The real issue lied within my way of loading the image to GPUImageView:</p>

<p>I grabbed the Uri, once the user supplied a picture via camera, gallery or share with my app function in my <code class="highlighter-rouge">onActivityResult</code> method:</p>

<p>[…]
case R.string.choose_photo:
case R.string.take_photo:
case R.string.share:
	if (resultCode == RESULT_OK) {
		final Uri uri;
		switch (requestCode) {
			case R.string.take_photo:
				// same as I configured via intent.putExtra(MediaStore.EXTRA_OUTPUT, mTempFileUri); in the photo intent
				uri = mTempFileUri;
				break;
			case R.string.share:
				uri = data.getParcelableExtra(Intent.EXTRA_STREAM);
				break;
			default:
				// some fixes for url-encoded paths like DropBox returns; and paths without “file://” scheme
				uri = Utils.extractProperFileUri(data.getData());
				break;
		}
		// now feed the image to GPUImageView
		mGPUImageView.setImage(uri);
	}
[…]</p>

<p>Setting the image by passing an Uri object, leads to this internal flow in GPUImage:</p>

<ol>
  <li>delegate loading to GPUImage, which will start a <code class="highlighter-rouge">LoadImageUriTask</code></li>
  <li>the above task will either load the image from web (uri starts with http or https) or using a <a href="http://developer.android.com/reference/android/content/ContentResolver.html">ContentResolver</a></li>
  <li>then, it will determine a proper size and <strong>rotation</strong> for the image, using a media query to <code class="highlighter-rouge">MediaStore.Images.ImageColumns.ORIENTATION</code></li>
  <li>.. and finally return the image resized and rotated to be displayed within the GPUImageView (involves calls to setRenderer and so forth)</li>
</ol>

<p>The problem lies within step 3, if the given Uri’s scheme is not <code class="highlighter-rouge">content</code> but <code class="highlighter-rouge">file</code>. Media queries work on proper content Uris, so Android can look into the meta data associated with the image from a <a href="http://developer.android.com/reference/android/provider/MediaStore.html">media collection</a>. On the other side, when passing an Uri with a <code class="highlighter-rouge">file</code>-scheme, the ContentResolver will find no additional meta data for a „generic file“ which resides on a given path. To get ahold of any additional image information, one should use the <a href="http://developer.android.com/reference/android/media/ExifInterface.html">ExifInterface</a> and read the <code class="highlighter-rouge">ExifInterface.TAG_ORIENTATION</code> from the file.</p>

<p>Fortunately, after a quick digging into the GPUImage code, I found that the method <code class="highlighter-rouge">mGPUImageView.setImage();</code> actually supports various types of parameters and then uses slightly different ways to load and interpret them:</p>

<p>// load the image directly from bitmap data
setImage(Bitmap bmp);</p>

<p>// load a file from the file system, interpreting exif data for proper rotation
setImage(File file);</p>

<p>// load a file from the internet or media store, using media query for proper rotation
setImage(Uri uri);</p>

<p>Since I also passed an Uri object when I referenced a file, GPUImage could not determine the proper rotation in the -non existing- media store data. Eventually, fixing this was as easy as that:</p>

<p>[…]
// now feed the image to GPUImageView
// either by File or other ContentResolver
// important for correct usage of detecting image rotation (File: ExifInterface; ContentResolver: MediaStore &gt; ImageColumns)
if (“file”.equals(uri.getScheme())) {
	mGPUImageView.setImage(new File(uri.getPath()));
} else {
	mGPUImageView.setImage(uri);
}</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Providing GPUImageView with the proper parameters in setImage() leads to correct rotation
</code></pre>
</div>

<p>I hope it helps someone facing the same issues. It is not specifically related to GPUImage, but to capturing an photo with Android and processing it in general, as you can see at <a href="http://stackoverflow.com/search?q=android+portrait+camera+90">stackoverflow</a>. GPUImage employs best practices to load an image properly, if provided with the correct parameters.</p>

<p>Big thanks to <a href="https://github.com/CyberAgent">CyberAgent</a> and <a href="https://github.com/pboos">pboos</a> for proding us with that port of the <a href="https://github.com/BradLarson/GPUImage">original GPUImage library for iOS</a>.</p>


      <hr />
      <footer role="contentinfo">
        <div class="social-share">
  <h4>Share on</h4>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=http://127.0.0.1:4000/android/gpuimage-rotates-portrait-image-90-degrees/" class="twitter" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=http://127.0.0.1:4000/android/gpuimage-rotates-portrait-image-90-degrees/" class="facebook" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=http://127.0.0.1:4000/android/gpuimage-rotates-portrait-image-90-degrees/" class="google-plus" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
    </li>
  </ul>
</div><!-- /.social-share -->
        <p class="byline"><strong>GPUImage dreht Portrait-Bild nach Fotografieren mit Kamera<!--:en-->GPUImage rotates an image shot in portrait mode by 90 degrees</strong> was published on <time datetime="2013-08-27T12:08:09+09:00">August 27, 2013</time>.</p>
      </footer>
    </div><!-- /.article-wrap -->
  
  </article>
</div><!-- /#main -->


  
  <aside class="read-next">
    <a class="read-next-story prev " style="" href="http://127.0.0.1:4000/formatting-post/" title="Formatting Post">
      <section class="post">
        <h2>Formatting Post</h2>
        Demo post displaying the various ways of highlighting code in Markdown.
      </section>
    </a>
  </aside>
  


<div class="footer-wrap">
  <footer>
    

<section class="copyright"><a href="http://127.0.0.1:4000">Maik Vlcek</a> &copy; 2016</section>
<section class="poweredby">Proudly published with <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a></section>

  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://127.0.0.1:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://127.0.0.1:4000/assets/js/scripts.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-1304393-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


  



</body>
</html>
